# Notification System Configuration

## Environment Variables

Add these to your `backend/.env` file:

```bash
# ============================================
# NOTIFICATION SYSTEM CONFIGURATION
# ============================================

# Scheduler frequency (cron expression)
# Default: 0 */6 * * * (every 6 hours)
# Options:
#   - 0 */6 * * *  = Every 6 hours (recommended)
#   - 0 */12 * * * = Every 12 hours (for low-activity orgs)
#   - 0 8 * * *    = Once daily at 8 AM (minimal)
#   - */15 * * * * = Every 15 minutes (old default - NOT recommended)
NOTIFICATION_CHECK_CRON=0 */6 * * *

# Enable/disable email notifications globally
# Default: true
# Set to 'false' to disable all email sending (emergency killswitch)
EMAIL_NOTIFICATIONS_ENABLED=true

# Morning briefing time (24-hour format)
# Default: 8 (8:00 AM)
# When to send daily digest emails
MORNING_BRIEFING_HOUR=8

# Frontend URL (for email links)
# Required for email notifications
FRONTEND_URL=http://localhost:5173

# Email service configuration (unchanged)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
```

---

## Quick Configuration Scenarios

### Scenario 1: Stop Email Spam Immediately (Emergency)
```bash
EMAIL_NOTIFICATIONS_ENABLED=false
```
**Effect:** All emails stopped, in-app notifications continue

---

### Scenario 2: Minimal Notifications (Small Team)
```bash
NOTIFICATION_CHECK_CRON=0 8 * * *  # Once daily
EMAIL_NOTIFICATIONS_ENABLED=true
```
**Effect:** Checks run once per day, critical emails still immediate

---

### Scenario 3: Aggressive Monitoring (Large Org)
```bash
NOTIFICATION_CHECK_CRON=0 */3 * * *  # Every 3 hours
EMAIL_NOTIFICATIONS_ENABLED=true
```
**Effect:** More frequent checks, but still throttled

---

### Scenario 4: Testing Phase 1
```bash
NOTIFICATION_CHECK_CRON=0 */6 * * *  # Default
EMAIL_NOTIFICATIONS_ENABLED=true
# Add debug logging
LOG_LEVEL=debug
```
**Effect:** Standard configuration with verbose logs

---

## Configuration Validation

After updating `.env`:

1. Restart backend server:
   ```bash
   cd backend
   npm run dev
   ```

2. Check logs for confirmation:
   ```
   âœ… Notification scheduler started { schedule: '0 */6 * * *', timezone: 'UTC' }
   âœ… Email notifications enabled
   ```

3. Test notification creation:
   - Create a decision with health < 40%
   - Should see: "ðŸš¨ Critical notification - sent immediate email"

---

## Monitoring

Check notification system health:

```sql
-- Recent notification volume
SELECT 
  DATE(created_at) as date,
  COUNT(*) as total,
  COUNT(CASE WHEN email_sent = true THEN 1 END) as emailed,
  COUNT(CASE WHEN email_sent = false THEN 1 END) as queued_for_briefing
FROM notifications
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- Throttling effectiveness
SELECT 
  type,
  COUNT(*) as created,
  COUNT(DISTINCT decision_id) as unique_decisions
FROM notifications
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY type
ORDER BY created DESC;

-- Email volume per user (before briefing implementation)
SELECT 
  u.email,
  COUNT(n.id) as notifications_received,
  COUNT(CASE WHEN n.email_sent = true THEN 1 END) as immediate_emails
FROM notifications n
JOIN decisions d ON n.decision_id = d.id
JOIN users u ON u.organization_id = d.organization_id
WHERE n.created_at > NOW() - INTERVAL '24 hours'
GROUP BY u.email
ORDER BY notifications_received DESC;
```

---

## Troubleshooting

### Problem: Too many emails still being sent
**Solution:** Check if notifications are marked CRITICAL severity
```sql
SELECT type, severity, COUNT(*) 
FROM notifications 
WHERE created_at > NOW() - INTERVAL '24 hours'
AND email_sent = true
GROUP BY type, severity;
```

### Problem: Critical notifications not sending emails
**Solution:** Check `EMAIL_NOTIFICATIONS_ENABLED` and email service config

### Problem: Scheduler not running
**Solution:** Verify cron expression is valid
```bash
# In backend logs, should see:
"Notification scheduler started"
```

### Problem: Notifications being throttled incorrectly
**Solution:** Check throttle logic targets correct resources
```sql
-- See what's being throttled
SELECT 
  type,
  decision_id,
  COUNT(*) as throttled_count
FROM notifications
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY type, decision_id
HAVING COUNT(*) > 1;
```

---

Last Updated: February 17, 2026
